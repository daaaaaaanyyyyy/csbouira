import{initializeApp}from"https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";import{getStorage,ref,uploadBytesResumable,getDownloadURL}from"https://www.gstatic.com/firebasejs/10.13.0/firebase-storage.js";import{firebaseConfig,API_KEYS}from"./apikeys.js";let app=initializeApp(firebaseConfig),storage=getStorage(app);document.getElementById("form").addEventListener("submit",async e=>{e.preventDefault();var e=e.target,a=new FormData(e),e=e.querySelector("#uploadfile"),n=e.files,d=document.getElementById("response"),t=document.getElementById("submit-upload"),r=document.getElementById("spinnerHidden");let o=document.getElementById("alerts");if(d.innerHTML="",o.innerHTML="",t.disabled=!0,r.style.display="inline-block",0<n.length){let t=0,i=[];for(let e=0;e<n.length;e++){let r=n[e];var m=ref(storage,"CSB_Uploaded_Files/"+r.name);let s=uploadBytesResumable(m,r);m=document.createElement("div");m.className="progress";let l=document.createElement("div");l.className="progress-bar",l.setAttribute("role","progressbar"),l.setAttribute("aria-valuenow","0"),l.setAttribute("aria-valuemin","0"),l.setAttribute("aria-valuemax","100"),l.style.width="0%",m.appendChild(l),d.appendChild(m),await new Promise((t,a)=>{s.on("state_changed",e=>{e=e.bytesTransferred/e.totalBytes*100;l.style.width=e+"%",l.setAttribute("aria-valuenow",e.toFixed(0))},e=>{o.innerHTML=`<div class="alert alert-danger" role="alert">
                      خطأ في رفع هذا الملف "${r.name}". حاول مرة أخرى. ${e.message}
                    </div>`,a(e)},async()=>{try{var e=await getDownloadURL(s.snapshot.ref);i.push({name:r.name,url:e}),o.innerHTML=`<div class="alert alert-success" role="alert">
                        تم رفع الملف "${r.name}" بنجاح!
                      </div>`,t()}catch(e){o.innerHTML=`<div class="alert alert-danger" role="alert">
                        خطأ عند إسخراج الرابط الخاص بالملف "${r.name}". حاول مرة أخرى. ${e.message}
                      </div>`,a(e)}})}),t++}if(t===n.length&&(d.innerHTML=""),t===n.length){var s=new FormData;s.append("name",a.get("name")),s.append("email",a.get("email")),s.append("module",a.get("module")),s.append("filetype",a.get("filetype")),s.append("grade",a.get("grade")),s.append("semestre",a.get("semestre")),s.append("fileLinks",JSON.stringify(i));try{var l=await fetch(API_KEYS.CSB_FIREBASE,{method:"POST",body:s});if(!l.ok)throw new Error("HTTP error! status: "+l.status);o.innerHTML=`<div class="alert alert-success" role="alert">
          تم رفع جميع الملفات بنجاح! شكرا.
        </div>`,e.value=""}catch(e){o.innerHTML=`<div class="alert alert-danger" role="alert">
          خطأ في إرسال البيانات. يرجى المحاولة مرة أخرى (راسلنا إذا ظهر هذا الخطأ). ${e.message}
        </div>`}}}else o.innerHTML=`<div class="alert alert-warning" role="alert">
      لم تختر الملفات التي تريد رفعها
    </div>`;t.disabled=!1,r.style.display="none"});